version: '3.1'

networks:
  public:
    driver: overlay
  apps:
    driver: overlay
    internal: true
  storage:
    external:
      name: biosentiers_storage

secrets:
  biosentiers_db_postgres_password_v1:
    external: true
  biosentiers_db_password_v1:
    external: true

services:

  rp:
    image: 127.0.0.1:5000/biosentiers/rp:${RP_TAG:-latest}
    depends_on:
      - backend
    deploy:
      mode: global
    networks:
      - public
      - apps
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "www_data:/var/www/app"

  backend:
    image: 127.0.0.1:5000/biosentiers/backend:${BACKEND_TAG:-latest}
    depends_on:
      - db
    deploy:
      replicas: 2
    environment:
      DATABASE_HOST: db
      DATABASE_USERNAME: biosentiers
      DATABASE_PASSWORD_FILE: /run/secrets/db_password
    networks:
      apps:
        aliases:
          - app
      storage:
    secrets:
      - source: biosentiers_db_password_v1
        target: db_password

  db:
    image: 127.0.0.1:5000/biosentiers/db:${DB_TAG:-latest}
    deploy:
      mode: global
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_postgres_password
      DATABASE_NAME: biosentiers
      DATABASE_USERNAME: biosentiers
      DATABASE_PASSWORD_FILE: /run/secrets/db_password
    networks:
      - storage
    secrets:
      - source: biosentiers_db_postgres_password_v1
        target: db_postgres_password
      - source: biosentiers_db_password_v1
        target: db_password
    volumes:
      - "db_data:/var/lib/postgresql/data"

volumes:
  db_data:
  www_data:
    external:
      name: biosentiers_www_data
